<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Restaurant Inventory Management</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Custom CSS -->
  <style>
    .nav-link {
      cursor: pointer;
    }
    .item-card {
      width: 120px;
      height: 120px;
      margin: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border: 1px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
      background-color: #f8f9fa;
    }
    .item-card:hover {
      transform: scale(1.05);
      background-color: #e9ecef;
    }
    .item-card img {
      width: 60px;
      height: 60px;
      margin-bottom: 10px;
    }
    .item-card span {
      font-size: 14px;
      text-align: center;
    }
    #itemsGrid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h1 class="text-center mb-4">Restaurant Inventory Management</h1>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="inventoryTabs">
      <li class="nav-item">
        <a class="nav-link active" id="currentStockTab" data-bs-toggle="tab" href="#currentStock">Current Stock</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="logUsageTab" data-bs-toggle="tab" href="#logUsage">Log Usage</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="addInventoryTab" data-bs-toggle="tab" href="#addInventory">Add Inventory</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="pastReceivedTab" data-bs-toggle="tab" href="#pastReceived">Past Received</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="reportsTab" data-bs-toggle="tab" href="#reports">Reports</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="reorderTab" data-bs-toggle="tab" href="#reorder">Reorder</a>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content mt-4">
      <!-- Current Stock Tab -->
      <div class="tab-pane fade show active" id="currentStock">
        <h2>Current Stock</h2>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Item Name</th>
              <th>Category</th>
              <th>Stock</th>
              <th>Unit</th>
              <th>Price</th>
              <th>Threshold</th>
            </tr>
          </thead>
          <tbody id="inventoryTableBody"></tbody>
        </table>
      </div>

      <!-- Log Usage Tab -->
      <div class="tab-pane fade" id="logUsage">
        <h2>Log Usage</h2>
        <!-- Category Dropdown -->
        <div class="mb-3">
          <label for="categorySelect" class="form-label">Select Category</label>
          <select class="form-select" id="categorySelect" onchange="updateItemsGrid()">
            <option value="">-- Select a Category --</option>
          </select>
        </div>

        <!-- Items Grid -->
        <div id="itemsGrid"></div>

        <!-- Past Usage Table -->
        <h3 class="mt-4">Past Usage</h3>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Date</th>
              <th>Item Name</th>
              <th>Category</th>
              <th>Quantity</th>
              <th>Unit</th>
              <th>Consumption Value</th>
              <th>Stock After Usage</th>
              <th>Stock Value After Usage</th>
            </tr>
          </thead>
          <tbody id="usageLogTableBody"></tbody>
        </table>
      </div>

      <!-- Add Inventory Tab -->
      <div class="tab-pane fade" id="addInventory">
        <h2>Add Inventory</h2>
        <form id="addInventoryForm">
          <div class="mb-3">
            <label for="addItem" class="form-label">Item</label>
            <select class="form-select" id="addItem" required></select>
          </div>
          <div class="mb-3">
            <label for="addQuantity" class="form-label">Quantity</label>
            <input type="number" class="form-control" id="addQuantity" min="1" required>
          </div>
          <button type="submit" class="btn btn-primary">Add Inventory</button>
        </form>
        <div id="addInventoryMessage" class="mt-3"></div>
      </div>

      <!-- Past Received Tab -->
      <div class="tab-pane fade" id="pastReceived">
        <h2>Past Received</h2>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Date</th>
              <th>Item Name</th>
              <th>Category</th>
              <th>Quantity</th>
              <th>Unit</th>
            </tr>
          </thead>
          <tbody id="receivedLogTableBody"></tbody>
        </table>
      </div>

      <!-- Reports Tab -->
      <div class="tab-pane fade" id="reports">
        <h2>Reports</h2>
        <div id="reportsContent"></div>
      </div>

      <!-- Reorder Tab -->
      <div class="tab-pane fade" id="reorder">
        <h2>Items to Reorder</h2>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Item Name</th>
              <th>Category</th>
              <th>Stock</th>
              <th>Unit</th>
              <th>Threshold</th>
            </tr>
          </thead>
          <tbody id="reorderTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal for Logging Usage -->
  <div class="modal fade" id="logUsageModal" tabindex="-1" aria-labelledby="logUsageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="logUsageModalLabel">Log Usage for <span id="modalItemName"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="modalLogUsageForm">
            <div class="mb-3">
              <label for="modalQuantity" class="form-label">Quantity</label>
              <input type="number" class="form-control" id="modalQuantity" min="1" required>
            </div>
            <button type="submit" class="btn btn-primary">Log Usage</button>
          </form>
          <div id="modalMessage" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS and Popper.js -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
  <script>
    const API_URL = "https://empty-block-6580.chaithanyagvn172.workers.dev/";
    let inventoryData = [];

    async function fetchData(method) {
      try {
        console.log(`Fetching data for method: ${method}`);
        const response = await fetch(`${API_URL}?method=${method}`);
        if (!response.ok) {
          const text = await response.text();
          console.error(`Non-OK response for ${method}: ${response.status} ${response.statusText}`, text);
          throw new Error(`Network error: ${response.status} ${response.statusText}`);
        }
        const contentType = response.headers.get('Content-Type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          console.error(`Invalid Content-Type for ${method}: ${contentType}`, text);
          throw new Error(`Invalid response format: Expected JSON, got ${contentType}`);
        }
        const data = await response.json();
        console.log(`Data received for ${method}:`, data);
        if (data && data.error) {
          console.warn(`Error in ${method}: ${data.error}`);
          return [];
        }
        return data;
      } catch (error) {
        console.error(`Error fetching ${method}:`, error);
        return [];
      }
    }

    async function fetchAllData() {
      const inventory = await fetchData("getInventory") || [];
      const usageLog = await fetchData("getUsageLog") || [];
      const receivedLog = await fetchData("getReceivedLog") || [];

      console.log("Inventory data in fetchAllData:", inventory);
      console.log("UsageLog data in fetchAllData:", usageLog);
      console.log("ReceivedLog data in fetchAllData:", receivedLog);

      inventoryData = inventory; // Store inventory data globally
      updateInventoryTable(inventory);
      updateUsageLogTable(usageLog);
      updateReceivedLogTable(receivedLog);
      updateReports(inventory, usageLog);
      updateReorderTable(inventory);
      populateCategoryDropdown(inventory);
    }

    function updateInventoryTable(inventory) {
      const tableBody = document.getElementById("inventoryTableBody");
      tableBody.innerHTML = "";
      inventory.forEach(item => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.name}</td>
          <td>${item.category}</td>
          <td>${item.stock}</td>
          <td>${item.unit}</td>
          <td>$${item.price.toFixed(2)}</td>
          <td>${item.threshold}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    function updateUsageLogTable(usageLog) {
      console.log("Updating usage log table with data:", usageLog);
      const tableBody = document.getElementById("usageLogTableBody");
      tableBody.innerHTML = "";
      usageLog.forEach(log => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${log.date}</td>
          <td>${log.itemName}</td>
          <td>${log.category}</td>
          <td>${log.quantity}</td>
          <td>${log.unit}</td>
          <td>$${log.consumptionValue.toFixed(2)}</td>
          <td>${log.currentStockAfterUsage}</td>
          <td>$${log.stockValueAfterUsage.toFixed(2)}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    function updateReceivedLogTable(receivedLog) {
      const tableBody = document.getElementById("receivedLogTableBody");
      tableBody.innerHTML = "";
      receivedLog.forEach(log => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${log.date}</td>
          <td>${log.itemName}</td>
          <td>${log.category}</td>
          <td>${log.quantity}</td>
          <td>${log.unit}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    function updateReports(inventory, usageLog) {
      const reportsContent = document.getElementById("reportsContent");
      let totalStockValue = inventory.reduce((sum, item) => sum + (item.stock * item.price), 0);
      let totalConsumptionValue = usageLog.reduce((sum, log) => sum + log.consumptionValue, 0);

      reportsContent.innerHTML = `
        <p><strong>Total Stock Value:</strong> $${totalStockValue.toFixed(2)}</p>
        <p><strong>Total Consumption Value:</strong> $${totalConsumptionValue.toFixed(2)}</p>
      `;
    }

    function updateReorderTable(inventory) {
      const tableBody = document.getElementById("reorderTableBody");
      tableBody.innerHTML = "";
      inventory.forEach(item => {
        if (item.stock <= item.threshold) {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.name}</td>
            <td>${item.category}</td>
            <td>${item.stock}</td>
            <td>${item.unit}</td>
            <td>${item.threshold}</td>
          `;
          tableBody.appendChild(row);
        }
      });
    }

    function populateCategoryDropdown(inventory) {
      const categorySelect = document.getElementById("categorySelect");
      const addItemSelect = document.getElementById("addItem");

      // Get unique categories
      const categories = [...new Set(inventory.map(item => item.category))].filter(cat => cat);
      console.log("Categories:", categories);

      // Populate category dropdown
      categorySelect.innerHTML = '<option value="">-- Select a Category --</option>';
      categories.forEach(category => {
        const option = document.createElement("option");
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
      });

      // Populate add inventory dropdown (unchanged)
      addItemSelect.innerHTML = '<option value="">-- Select an Item --</option>';
      inventory.forEach(item => {
        const option = document.createElement("option");
        option.value = item.name;
        option.textContent = item.name;
        addItemSelect.appendChild(option);
      });
    }

    function updateItemsGrid() {
      const categorySelect = document.getElementById("categorySelect");
      const itemsGrid = document.getElementById("itemsGrid");
      const selectedCategory = categorySelect.value;

      itemsGrid.innerHTML = "";
      if (!selectedCategory) return;

      const filteredItems = inventoryData.filter(item => item.category === selectedCategory);
      console.log("Filtered items for category", selectedCategory, ":", filteredItems);

      filteredItems.forEach(item => {
        const card = document.createElement("div");
        card.className = "item-card";
        card.onclick = () => openLogUsageModal(item.name);
        card.innerHTML = `
          <img src="https://via.placeholder.com/60?text=${item.name.charAt(0)}" alt="${item.name}">
          <span>${item.name}</span>
        `;
        itemsGrid.appendChild(card);
      });
    }

    function openLogUsageModal(itemName) {
      const modal = new bootstrap.Modal(document.getElementById("logUsageModal"));
      document.getElementById("modalItemName").textContent = itemName;
      document.getElementById("modalQuantity").value = "";
      document.getElementById("modalMessage").innerHTML = "";
      modal.show();
    }

    async function logUsage(itemName, quantity) {
      try {
        console.log(`Logging usage: itemName=${itemName}, quantity=${quantity}`);
        const response = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            method: "logUsage",
            itemName: itemName,
            quantity: quantity,
          }),
        });
        const result = await response.json();
        console.log("Response from logUsage:", result);
        if (result.success) {
          return { success: true, message: `Successfully logged usage. New stock: ${result.newStock}` };
        } else {
          return { success: false, message: `Failed to log usage: ${result.error}` };
        }
      } catch (error) {
        console.error("Error in logUsage:", error);
        return { success: false, message: "Network error: " + error.message };
      }
    }

    document.getElementById("modalLogUsageForm").onsubmit = async function (event) {
      event.preventDefault();
      const itemName = document.getElementById("modalItemName").textContent;
      const quantity = parseInt(document.getElementById("modalQuantity").value);
      const modalMessage = document.getElementById("modalMessage");

      if (!quantity || quantity <= 0) {
        modalMessage.innerHTML = '<div class="alert alert-danger">Please enter a valid quantity.</div>';
        return;
      }

      const result = await logUsage(itemName, quantity);
      if (result.success) {
        modalMessage.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
        setTimeout(() => {
          bootstrap.Modal.getInstance(document.getElementById("logUsageModal")).hide();
          fetchAllData(); // Refresh data
        }, 1000);
      } else {
        modalMessage.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
      }
    };

    document.getElementById("addInventoryForm").onsubmit = async function (event) {
      event.preventDefault();
      const itemName = document.getElementById("addItem").value;
      const quantity = parseInt(document.getElementById("addQuantity").value);
      const messageDiv = document.getElementById("addInventoryMessage");

      if (!itemName || !quantity || quantity <= 0) {
        messageDiv.innerHTML = '<div class="alert alert-danger">Please select an item and enter a valid quantity.</div>';
        return;
      }

      try {
        const response = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            method: "addInventory",
            itemName: itemName,
            quantity: quantity,
          }),
        });
        const result = await response.json();
        if (result.success) {
          messageDiv.innerHTML = `<div class="alert alert-success">Successfully added inventory. New stock: ${result.newStock}</div>`;
          document.getElementById("addInventoryForm").reset();
          fetchAllData();
        } else {
          messageDiv.innerHTML = `<div class="alert alert-danger">Failed to add inventory: ${result.error}</div>`;
        }
      } catch (error) {
        messageDiv.innerHTML = `<div class="alert alert-danger">Network error: ${error.message}</div>`;
      }
    };

    // Fetch data on page load
    fetchAllData();
  </script>
</body>
</html>
